import{$ as u,r as S,s as m,a as x,b as w,l as E,c as R,h as T,d as I}from"./main-DRDdlS_a.js";import"./responsive.bootstrap4-D6bLrdb5.js";var g=void 0;let f=!1;const h=10*1e3,p=60*1e3;let c=p,d=[];function _(){const a=document.getElementById("page-meta");if(a===null)return!1;try{return JSON.parse(a.textContent).IsDS||!1}catch(s){return console.error("Failed to parse page-meta JSON:",s),!1}}function D(a){var s="/targets/list";const e=JSON.parse(document.getElementById("csrf-data").textContent);let n={};n[e.CSRFNAME]=e.CSRFToken,_()===!0&&(n.is_ds=!0);let t={...n};g=u("#scan-list").DataTable({aaSorting:[],searching:!1,destroy:!0,serverSide:!0,paging:!0,initComplete:function(){u(".dt-button").removeClass("dt-button"),u(".dataTables_length").addClass("control-label pt-3")},processing:!1,responsive:{details:{responsive:!0,display:u.fn.dataTable.Responsive.display.childRowImmediate,type:"none",target:""}},serverSide:!0,stateSave:!1,lengthMenu:[[10,50,100],[10,50,100]],ajax:{url:s,dataType:"json",type:"POST",data:t,dataSrc:"records",error:function(o,r,i){o.status==303?S():m("Unable to fetch data. Please try again later. If the problem persists, please contact support.")}},columns:[{data:"target_address"},{data:"scan_status_text"},{data:"scan_started_time"},{data:"scan_completed_time"},{data:"action"}],rowId:"id",drawCallback:function(){C(),f?c=p:c=h,setTimeout(y,c)}})}u(document).ready(function(){u(".dataTables_filter input").attr("placeholder","Search..."),D(),g.on("draw.dt",function(s,e){C(),f?c=p:c=h,setTimeout(y,c)});function a(s,e){e&&e.child&&e.child.isShown()&&(e.child.hide(),e.child.remove()),s.draw(!1)}u("body").on("click",".delete-target",function(s){if(s.preventDefault(),!confirm("Are you sure want to delete the scan"))return;const e=JSON.parse(document.getElementById("csrf-data").textContent);let n=u(this).closest("tr").attr("id");u.ajax({type:"DELETE",url:"/targets/"+n,headers:{"X-CSRF-Token":e.CSRFToken,"X-Requested-With":"XMLHttpRequest"},disableLoading:!0,success:function(t){if(t.redirect&&S(t.redirect),t.error)m(t.error);else if(t.success){x(t.success);let o=g.row("#"+n);a(g,o)}},error:function(t,o,r){if(t.status===422){var i=t.responseJSON;i&&i.error?m(i.error):m("Unprocessable Entity: Invalid request parameters.")}else m("An unexpected error occurred: "+o)}})})});w(function(){const a=document.getElementById("add-scan-form");if(!a)return;const s=document.getElementById("add-scan-btn");a.addEventListener("submit",function(e){s.disabled=!0,e.preventDefault(),E();const n=new FormData(a);R("/targets/add",{method:"POST",body:n}).then(t=>t.json().then(o=>({ok:t.ok,data:o}))).then(({ok:t,data:o})=>{if(T(),!t)throw new Error(o.error||"Error occurred");o.success?(I("#add-scan-form"),x(o.success)):o.redirect&&S(o.redirect),s.disabled=!1}).catch(t=>{console.log(t),T(),m(t.message),s.disabled=!1})})});function C(){const a=JSON.parse(document.getElementById("target-status-map").textContent);let s=!1;d=[],g.rows().every(function(){let e=this.data();const n=e.scan_status;n===a.YetToStart?d.push({id:e.id,scan_status:n}):n===a.ScanStarted&&(d.push({id:e.id,scan_status:n}),s=!0)}),s?(c=p,f=!0):(f=!1,c=h)}function N(){const a=JSON.parse(document.getElementById("target-status-map").textContent);let s=d.map(function(e,n,t){return e.id});u.ajax({type:"POST",url:"check-multi-status",disableLoading:!0,data:{target_ids:s},success:function(e){if(e.data)for(let o in e.data){let r=e.data[o],i=r.id;var n=g.row("#"+i),t=n.data();if(t===void 0)continue;let l="";r.scan_status!==void 0&&(d=d.map(function(b,k,v){return b.id==i&&(b.scan_status=r.scan_status),b}),r.scan_status===a.ScanStarted?(t.scan_started_time=r.scan_started_time,t.scan_status_text='<span class="spinner-border spinner-border-sm text-primary" aria-hidden="true"></span> <span role="status">Scanning...</span>',f=!0):t.scan_status_text=r.scan_status_text,r.scan_status==a.ReportGenerated?(t.scan_completed_time=r.scan_completed_time,l='<a href="/targets/'+i+'/report" class="btn btn-sm btn-primary m-1 report-button">Report</a>'):l='<a href="/targets/'+i+'/report" class="btn btn-sm btn-dark m-1 report-button disabled" disabled>Report</a>',r.show_alerts_btn?_()?l+='<a href="/targets/'+i+'/ds-results" class="btn btn-sm btn-primary m-1 alerts-button">Alerts</a>':l+='<a href="/targets/'+i+'/scan-results" class="btn btn-sm btn-primary m-1 alerts-button">Alerts</a>':_()?l+='<a href="/targets/'+i+'/ds-results" class="btn btn-sm btn-dark m-1 alerts-button disabled" disabled>Alerts</a>':l+='<a href="/targets/'+i+'/scan-results" class="btn btn-sm btn-dark m-1 alerts-button disabled" disabled>Alerts</a>',(r.scan_status===a.ScanFailed||r.scan_status===a.Unreachable||r.scan_status===a.ReportGenerated)&&(d=d.filter(function(b,k,v){return b.id!=i})),r.scan_status===a.ScanStarted?l+='<a href="#" class="btn btn-sm btn-dark text-white m-1 delete-target disabled" disabled>Delete</a>':l+='<a href="#" class="btn btn-sm btn-danger text-white m-1 delete-target">Delete</a>',l!==""&&(t.action=l),n.scan_status=r.scan_status,n.data(t))}}}).always(function(){A()})}function y(){if(console.log("initiating Checking status"),d.length===0){console.log("Finished Checking status at "+new Date().toLocaleString());return}console.log("Checking status at "+new Date().toLocaleString()),N()}function A(){const a=JSON.parse(document.getElementById("target-status-map").textContent);if(d.length===0){console.log("Finished Checking status at "+new Date().toLocaleString());return}c===h&&f?(console.log("Resetting the status check interval to 60 seconds"),c=p):(f=d.some(function(s,e,n){return s.scan_status==a.ScanStarted}),!f&&c===p&&(console.log("Resetting the status check interval to 10 seconds"),c=h)),setTimeout(y,c)}
